// Prisma Schema - Iteration 2: RBAC Foundation
// Added Role, Permission, UserRole models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // RBAC relations
  userRoles UserRole[]

  // Vendor relation
  vendor Vendor?

  // Cart & Order relations
  cart      Cart?
  addresses Address[]
  orders    Order[]
  refunds   Refund[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userRoles   UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  resource    String // e.g., "products", "orders", "users"
  action      String // e.g., "create", "read", "update", "delete"
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// Iteration 3: Vendor & Store models
model Vendor {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  legalName    String   @map("legal_name")
  businessType String   @map("business_type")
  taxId        String?  @map("tax_id")
  phone        String?
  address      String?
  isVerified   Boolean  @default(false) @map("is_verified")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  store      Store?
  orderItems OrderItem[]

  @@map("vendors")
}

model Store {
  id          String   @id @default(uuid())
  vendorId    String   @unique @map("vendor_id")
  name        String
  slug        String   @unique
  description String?
  logo        String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  products Product[]

  @@map("stores")
}

// Iteration 4: Product Management
model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  parentId    String?  @map("parent_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Self relation for subcategories
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children Category[] @relation("CategoryToCategory")
  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  storeId     String   @map("store_id")
  categoryId  String?  @map("category_id")
  title       String
  slug        String   @unique
  description String?
  basePrice   Decimal  @map("base_price") @db.Decimal(10, 2)
  sku         String   @unique
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  store      Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category   Category?        @relation(fields: [categoryId], references: [id])
  variants   ProductVariant[]
  images     ProductImage[]
  inventory  Inventory?
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("products")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  name      String // e.g., "Small", "Red", "256GB"
  sku       String   @unique
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variants")
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  url       String
  altText   String?  @map("alt_text")
  isPrimary Boolean  @default(false) @map("is_primary")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model Inventory {
  id        String   @id @default(uuid())
  productId String   @unique @map("product_id")
  quantity  Int      @default(0)
  lowStock  Int      @default(10) @map("low_stock_threshold")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("inventory")
}

// Iteration 5: Shopping Cart & Orders
model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Address {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  fullName     String   @map("full_name")
  phone        String
  addressLine1 String   @map("address_line_1")
  addressLine2 String?  @map("address_line_2")
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String   @default("India")
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Order {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  addressId    String      @map("address_id")
  orderNumber  String      @unique @map("order_number")
  status       OrderStatus @default(PENDING)
  subtotal     Decimal     @db.Decimal(10, 2)
  tax          Decimal     @default(0) @db.Decimal(10, 2)
  shippingCost Decimal     @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total        Decimal     @db.Decimal(10, 2)
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  user    User        @relation(fields: [userId], references: [id])
  address Address     @relation(fields: [addressId], references: [id])
  items   OrderItem[]
  payment Payment?
  refund  Refund?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  vendorId  String   @map("vendor_id")
  title     String
  sku       String
  price     Decimal  @db.Decimal(10, 2)
  quantity  Int
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  vendor  Vendor  @relation(fields: [vendorId], references: [id])

  @@map("order_items")
}

// Iteration 6: Razorpay Payments
enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

model Payment {
  id                String        @id @default(uuid())
  orderId           String        @unique @map("order_id")
  razorpayOrderId   String        @unique @map("razorpay_order_id")
  razorpayPaymentId String?       @map("razorpay_payment_id")
  razorpaySignature String?       @map("razorpay_signature")
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  order  Order   @relation(fields: [orderId], references: [id])
  refund Refund?

  @@map("payments")
}

// Iteration 8: Refund Management
enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  PROCESSED
}

model Refund {
  id               String       @id @default(uuid())
  paymentId        String       @unique @map("payment_id")
  orderId          String       @unique @map("order_id")
  userId           String       @map("user_id")
  amount           Decimal      @db.Decimal(10, 2)
  reason           String
  status           RefundStatus @default(REQUESTED)
  adminNotes       String?      @map("admin_notes")
  processedBy      String?      @map("processed_by")
  processedAt      DateTime?    @map("processed_at")
  razorpayRefundId String?      @map("razorpay_refund_id")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("refunds")
}

// Audit Logging
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldValue  String?  @map("old_value")
  newValue  String?  @map("new_value")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
